{% extends "base.html" %}
{% block title %}DSAWebLectures{% endblock %}
{% block content %}

<div id="bg-grid"></div>

<div class="homepage-wrapper">

  <!-- WELCOME -->
  <section id="welcome-section">
    <h1>Welcome to <span class="accent">DSALectures</span></h1>
    <small>subject to change</small>
  </section>

  <!-- FEED RESULTS -->
  <div id="feed-scroll"></div>

  <!-- CHAT INPUT -->
  <div class="chat-input-bar">
    <input id="home-search" type="text" placeholder="Ask or search..." />
    <button class="chat-send-btn" id="chat-send">Send</button>
  </div>

</div>
{% endblock content %}

{% block scripts %}
<script>
const searchBar = document.getElementById("home-search");
const feed = document.getElementById("feed-scroll");
const welcome = document.getElementById("welcome-section");
const sendBtn = document.getElementById("chat-send");

function displayResults(data) {
  feed.innerHTML = "";
  welcome.style.display = "none";

  if (!data || data.length === 0) {
    feed.innerHTML = `<div class="ai-response">No posts found matching your search.</div>`;
    return;
  }

  data.forEach(post => {
    const bubble = document.createElement("div");
    bubble.className = "ai-response";
    bubble.innerHTML = `
      <strong>${post.title}</strong><br>
      <span class="preserve">${post.caption}</span>
    `;
    feed.appendChild(bubble);
  });

  feed.scrollTop = feed.scrollHeight;
}

function performSearch() {
  const query = searchBar.value.trim();
  if (query === "") return;

  fetch(`/search_posts?q=${encodeURIComponent(query)}`, {
    method: "GET",
    headers: { "Accept": "application/json" }
  })
    .then(response => {
      if (!response.ok) throw new Error("Network error");
      return response.json();
    })
    .then(data => displayResults(data))
    .catch(err => {
      console.error(err);
      feed.innerHTML = `<div class="ai-response">Error searching posts.</div>`;
    });
}

searchBar.addEventListener("keydown", e => {
  if (e.key === "Enter") performSearch();
});
sendBtn.addEventListener("click", performSearch);

const grid = document.getElementById("bg-grid");

function generateGrid() {
  grid.innerHTML = "";

  const size = 30;
  const cols = Math.ceil(window.innerWidth / size);
  const rows = Math.ceil(window.innerHeight / size);

  grid.style.gridTemplateColumns = `repeat(${cols}, ${size}px)`;
  grid.style.gridTemplateRows = `repeat(${rows}, ${size}px)`;

  for (let i = 0; i < cols * rows; i++) {
    const cell = document.createElement("div");
    cell.classList.add("grid-cell");
    grid.appendChild(cell);
  }
}

generateGrid();
window.addEventListener("resize", generateGrid);
</script>

{% endblock scripts %}
